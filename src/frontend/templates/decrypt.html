{% extends "base.html" %}

{% block title %}Decryption Dashboard - SecureHealth{% endblock %}

{% block head %}
<style>
    .decrypt-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .page-title {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2rem;
        background: linear-gradient(135deg, var(--success), var(--primary-400));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .main-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
        align-items: start;
    }

    @media (max-width: 1024px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Sidebar */
    .sidebar {
        position: sticky;
        top: 100px;
    }

    .sidebar-card {
        background: var(--bg-surface);
        border: 1px solid var(--slate-800);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .sidebar-card h3 {
        font-size: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sidebar-card h3 i {
        color: var(--primary-400);
    }

    /* Explanation Card */
    .explanation-card {
        background: linear-gradient(145deg, rgba(16, 185, 129, 0.05), var(--bg-surface));
        border-color: rgba(16, 185, 129, 0.3);
    }

    .explanation-card h4 {
        color: var(--success);
        font-size: 0.9375rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .explanation-card p {
        font-size: 0.8125rem;
        color: var(--text-muted);
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .explanation-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .explanation-list li {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-muted);
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--slate-800);
    }

    .explanation-list li:last-child {
        border-bottom: none;
    }

    .explanation-list li i {
        margin-top: 0.15rem;
        flex-shrink: 0;
    }

    /* Legend Card */
    .legend-card {
        background: var(--bg-surface-2);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        font-size: 0.8125rem;
    }

    .legend-icon {
        width: 28px;
        height: 28px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .legend-icon.aes {
        background: rgba(43, 127, 255, 0.2);
        color: var(--primary-400);
    }

    .legend-icon.ckks {
        background: rgba(245, 158, 11, 0.2);
        color: var(--accent);
    }

    .legend-icon.decrypted {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
    }

    /* Main Viewer */
    .viewer-card {
        background: var(--bg-surface);
        border: 1px solid var(--slate-800);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        min-height: 600px;
        display: flex;
        flex-direction: column;
    }

    .viewer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--slate-800);
    }

    .viewer-title {
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .viewer-title i {
        color: var(--success);
    }

    .viewer-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .page-btn {
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius);
        background: var(--bg-surface-2);
        border: 1px solid var(--slate-700);
        cursor: pointer;
        color: var(--text-muted);
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
        background: var(--slate-700);
        color: var(--text-main);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-info {
        font-size: 0.8125rem;
        color: var(--text-muted);
        padding: 0 0.5rem;
    }

    /* Table */
    .data-table-container {
        flex: 1;
        overflow-x: auto;
        position: relative;
    }

    .loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        gap: 1rem;
    }

    .loading-overlay i {
        font-size: 2.5rem;
        color: var(--primary-400);
    }

    .loading-overlay p {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .data-table thead {
        background: var(--bg-surface-2);
        position: sticky;
        top: 0;
        z-index: 5;
    }

    .data-table th {
        padding: 0.75rem 1rem;
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        text-align: left;
        border-bottom: 1px solid var(--slate-700);
        white-space: nowrap;
    }

    .data-table th.clickable {
        cursor: pointer;
        transition: color 0.2s;
    }

    .data-table th.clickable:hover {
        color: var(--primary-400);
    }

    .data-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--slate-800);
        vertical-align: middle;
    }

    .data-table tr:hover {
        background: var(--bg-surface-2);
    }

    .cell-encrypted {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: monospace;
        font-size: 0.75rem;
    }

    .cell-encrypted.aes {
        color: var(--primary-400);
    }

    .cell-encrypted.ckks {
        color: var(--accent);
    }

    .cell-decrypted {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-main);
    }

    .cell-decrypted i {
        color: var(--success);
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
        flex: 1;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--bg-surface-2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    .empty-icon i {
        font-size: 2rem;
        color: var(--text-muted);
    }

    .empty-title {
        font-size: 1.25rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .empty-text {
        font-size: 0.9375rem;
        color: var(--text-muted);
        max-width: 400px;
        line-height: 1.6;
    }

    /* Mode Pills */
    .mode-pills {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .mode-pill {
        flex: 1;
        padding: 0.75rem;
        border-radius: var(--radius);
        border: 1px solid var(--slate-700);
        background: var(--bg-surface-2);
        cursor: pointer;
        text-align: center;
        font-size: 0.8125rem;
        color: var(--text-muted);
        transition: all 0.2s;
    }

    .mode-pill:hover {
        border-color: var(--slate-600);
        color: var(--text-main);
    }

    .mode-pill.active {
        border-color: var(--primary-600);
        background: rgba(43, 127, 255, 0.1);
        color: var(--primary-300);
    }

    .mode-pill i {
        display: block;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-8">
    <div class="decrypt-container">
        <h1 class="page-title"><i class="fas fa-unlock-alt"></i> Interactive Decryption</h1>

        <div class="main-grid">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Dataset Selection -->
                <div class="sidebar-card">
                    <h3><i class="fas fa-database"></i> Select Dataset</h3>
                    <select id="datasetSelect" class="input w-full mb-4">
                        <option value="" disabled selected>Loading datasets...</option>
                    </select>

                    <!-- Mode Selection -->
                    <div class="mode-pills">
                        <label class="mode-pill active" data-mode="field">
                            <i class="fas fa-columns"></i>
                            Field
                        </label>
                        <label class="mode-pill" data-mode="record">
                            <i class="fas fa-grip-lines"></i>
                            Record
                        </label>
                    </div>

                    <hr style="border-color: var(--slate-700); margin: 1rem 0;">

                    <button id="batchDecryptBtn" class="btn btn-primary w-full mb-2">
                        <i class="fas fa-unlock-alt"></i> Batch Decrypt All
                    </button>
                    <button id="exportBtn" class="btn btn-secondary w-full" disabled>
                        <i class="fas fa-download"></i> Export Decrypted JSON
                    </button>
                </div>

                <!-- Explanation Card -->
                <div class="sidebar-card explanation-card">
                    <h4><i class="fas fa-info-circle"></i> How Decryption Works</h4>
                    <p>
                        Your data is encrypted with two layers. You can decrypt individual cells,
                        entire columns, or whole records on-demand.
                    </p>
                    <ul class="explanation-list">
                        <li>
                            <i class="fas fa-mouse-pointer text-primary"></i>
                            <span><strong>Click a column header</strong> to decrypt that field for all visible
                                rows</span>
                        </li>
                        <li>
                            <i class="fas fa-key text-accent"></i>
                            <span><strong>Click the key button</strong> on a row to decrypt all fields in that
                                record</span>
                        </li>
                        <li>
                            <i class="fas fa-layer-group text-success"></i>
                            <span><strong>Batch Decrypt</strong> decrypts the entire dataset for export</span>
                        </li>
                    </ul>
                </div>

                <!-- Legend Card -->
                <div class="sidebar-card legend-card">
                    <h3 style="margin-bottom: 0.75rem;"><i class="fas fa-palette"></i> Legend</h3>
                    <div class="legend-item">
                        <div class="legend-icon aes"><i class="fas fa-lock"></i></div>
                        <div>
                            <div style="font-weight: 600;">AES-256 Encrypted</div>
                            <div style="font-size: 0.6875rem; color: var(--text-muted);">Text/PII fields (name, ID)
                            </div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon ckks"><i class="fas fa-calculator"></i></div>
                        <div>
                            <div style="font-weight: 600;">CKKS Encrypted</div>
                            <div style="font-size: 0.6875rem; color: var(--text-muted);">Numeric fields (allows
                                computation)</div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon decrypted"><i class="fas fa-lock-open"></i></div>
                        <div>
                            <div style="font-weight: 600;">Decrypted</div>
                            <div style="font-size: 0.6875rem; color: var(--text-muted);">Plaintext value revealed</div>
                        </div>
                    </div>
                </div>

                <!-- Back Button -->
                <a href="/upload" class="btn btn-secondary w-full">
                    <i class="fas fa-arrow-left"></i> Back to Upload
                </a>
            </div>

            <!-- Main Viewer -->
            <div class="viewer-card">
                <div class="viewer-header">
                    <h2 class="viewer-title">
                        <i class="fas fa-table"></i>
                        <span id="viewerTitle">Encrypted Data Viewer</span>
                    </h2>
                    <div class="viewer-controls">
                        <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="loading-overlay hidden" id="loadingOverlay">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading encrypted data...</p>
                    </div>

                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Empty State -->
                        </tbody>
                    </table>

                    <!-- Empty State (shown when no dataset selected) -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <h3 class="empty-title">No Dataset Selected</h3>
                        <p class="empty-text">
                            Select an encrypted dataset from the dropdown to view and decrypt its contents.
                            Each field can be decrypted individually.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let currentDataset = null;
    let currentPage = 0;
    const pageSize = 10;
    let totalRecords = 0;
    let currentData = [];
    let decryptMode = 'field';

    // Mode selection
    document.querySelectorAll('.mode-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            document.querySelectorAll('.mode-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            decryptMode = pill.dataset.mode;
        });
    });

    // Load Datasets
    async function loadDatasets() {
        try {
            const res = await fetch('/datasets/list');
            const data = await res.json();
            const sel = document.getElementById('datasetSelect');

            if (!data.datasets || data.datasets.length === 0) {
                sel.innerHTML = '<option disabled>No datasets found - upload data first</option>';
                return;
            }

            sel.innerHTML = '<option value="" disabled selected>Select a dataset...</option>' +
                data.datasets.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

            // Check URL param for pre-selection
            const urlParams = new URLSearchParams(window.location.search);
            const dsId = urlParams.get('dataset');
            if (dsId) {
                // Check if dataset exists
                const exists = data.datasets.some(d => d.id === dsId);
                if (exists) {
                    sel.value = dsId;
                    loadDatasetData(dsId);
                } else {
                    notify.warning('Dataset Not Found', 'The requested dataset was not found. Please select another.');
                }
            }
        } catch (e) {
            console.error(e);
            document.getElementById('datasetSelect').innerHTML = '<option disabled>Error loading datasets</option>';
        }
    }

    document.getElementById('datasetSelect').addEventListener('change', (e) => {
        loadDatasetData(e.target.value);
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('dataset', e.target.value);
        window.history.pushState({}, '', url);
    });

    async function loadDatasetData(id) {
        currentDataset = id;
        currentPage = 0;
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('dataTable').classList.remove('hidden');
        fetchPage();
    }

    async function fetchPage() {
        if (!currentDataset) return;

        document.getElementById('loadingOverlay').classList.remove('hidden');

        try {
            const res = await fetch(`/decrypt/preview/${currentDataset}?limit=${pageSize}&offset=${currentPage * pageSize}`);
            const data = await res.json();

            if (data.error) {
                throw new Error(data.error);
            }

            currentData = data.records;
            totalRecords = data.total;

            document.getElementById('viewerTitle').textContent = `Encrypted Data (${totalRecords} records)`;
            renderTable(currentData);
            updatePagination();

        } catch (e) {
            console.error(e);
            notify.error('Error', 'Failed to load dataset: ' + e.message);
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }

    function renderTable(records) {
        const thead = document.getElementById('tableHeader');
        const tbody = document.getElementById('tableBody');

        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-muted">No records found</td></tr>';
            return;
        }

        const cols = Object.keys(records[0]);

        // Header
        thead.innerHTML = `
      <th>#</th>
      ${cols.map(c => `
        <th class="clickable" onclick="decryptColumn('${c}')" title="Click to decrypt this column">
          ${c.replace(/_/g, ' ')} 
          <i class="fas fa-unlock text-xs ml-1 opacity-50"></i>
        </th>
      `).join('')}
      <th>Action</th>
    `;

        // Body
        tbody.innerHTML = records.map((row, idx) => {
            const globalIdx = currentPage * pageSize + idx;
            return `
        <tr>
          <td style="font-family: monospace; font-size: 0.75rem; color: var(--text-muted);">${globalIdx + 1}</td>
          ${cols.map(c => {
                const val = row[c];
                let content = '';

                if (typeof val === 'object' && val && val.ciphertext) {
                    content = `<span class="cell-encrypted aes"><i class="fas fa-lock"></i> AES Encrypted</span>`;
                } else if (typeof val === 'object' && val && val.ckks) {
                    content = `<span class="cell-encrypted ckks"><i class="fas fa-calculator"></i> CKKS Encrypted</span>`;
                } else {
                    content = `<span class="cell-decrypted">${val ?? ''}</span>`;
                }

                return `<td id="cell-${globalIdx}-${c}">${content}</td>`;
            }).join('')}
          <td>
            <button class="btn btn-xs btn-secondary" onclick="decryptRow(${globalIdx})" title="Decrypt this row">
              <i class="fas fa-key"></i>
            </button>
          </td>
        </tr>
      `;
        }).join('');
    }

    function updatePagination() {
        const totalPages = Math.ceil(totalRecords / pageSize) || 1;
        document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages}`;
        document.getElementById('prevPage').disabled = currentPage === 0;
        document.getElementById('nextPage').disabled = (currentPage + 1) * pageSize >= totalRecords;
    }

    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            fetchPage();
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        if ((currentPage + 1) * pageSize < totalRecords) {
            currentPage++;
            fetchPage();
        }
    });

    // Decryption Functions
    window.decryptRow = async (idx) => {
        const btn = document.querySelector(`button[onclick="decryptRow(${idx})"]`);
        const row = btn.closest('tr');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await fetch('/decrypt/record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dataset_id: currentDataset,
                    record_index: idx
                })
            });
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            // Update UI
            const decRec = data.decrypted_record;
            Object.keys(decRec).forEach(key => {
                const cell = document.getElementById(`cell-${idx}-${key}`);
                if (cell) {
                    cell.innerHTML = `<span class="cell-decrypted"><i class="fas fa-lock-open"></i> ${decRec[key]}</span>`;
                }
            });

            btn.innerHTML = '<i class="fas fa-check text-success"></i>';
            notify.success('Decrypted', `Record #${idx + 1} decrypted`);

        } catch (e) {
            notify.error('Error', 'Decryption failed: ' + e.message);
            btn.innerHTML = '<i class="fas fa-key"></i>';
        } finally {
            btn.disabled = false;
        }
    };

    window.decryptColumn = async (field) => {
        if (!confirm(`Decrypt field "${field}" for all visible rows?`)) return;

        const indices = Array.from({ length: currentData.length }, (_, i) => currentPage * pageSize + i);

        try {
            const res = await fetch('/decrypt/field', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dataset_id: currentDataset,
                    field_name: field,
                    record_indices: indices
                })
            });
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            // Update UI
            Object.entries(data.results).forEach(([idx, val]) => {
                const cell = document.getElementById(`cell-${idx}-${field}`);
                if (cell) {
                    cell.innerHTML = `<span class="cell-decrypted"><i class="fas fa-lock-open"></i> ${val}</span>`;
                }
            });

            notify.success('Column Decrypted', `Field "${field}" decrypted for ${Object.keys(data.results).length} rows`);

        } catch (e) {
            notify.error('Error', 'Column decryption failed: ' + e.message);
        }
    };

    // Batch Decrypt
    document.getElementById('batchDecryptBtn').addEventListener('click', async () => {
        if (!currentDataset) {
            notify.warning('No Dataset', 'Please select a dataset first');
            return;
        }

        if (!confirm('This will decrypt ALL records in the dataset. Continue?')) return;

        const btn = document.getElementById('batchDecryptBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

        try {
            const res = await fetch('/decrypt/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataset_id: currentDataset })
            });
            const data = await res.json();

            // Poll status
            const interval = setInterval(async () => {
                const sRes = await fetch(`/decrypt/status/${data.task_id}`);
                const sData = await sRes.json();

                if (sData.status === 'completed') {
                    clearInterval(interval);
                    btn.innerHTML = '<i class="fas fa-check"></i> Complete!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('exportBtn').onclick = () => window.location.href = sData.download_url;
                    notify.success('Batch Complete', 'All records decrypted! You can now export.');
                } else if (sData.status === 'failed') {
                    clearInterval(interval);
                    btn.innerHTML = '<i class="fas fa-times"></i> Failed';
                    btn.disabled = false;
                    notify.error('Failed', sData.error);
                } else {
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${sData.progress}%`;
                }
            }, 1000);

        } catch (e) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-unlock-alt"></i> Batch Decrypt All';
            notify.error('Error', 'Failed to start batch decryption');
        }
    });

    // Initialize
    loadDatasets();
</script>
{% endblock %}