{% extends "base.html" %}

{% block title %}Metrics Dashboard - Thesis Validation{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .metrics-dashboard {
        padding: 2rem 0;
    }

    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .kpi-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .kpi-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .kpi-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }

    .kpi-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .tab-navigation {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 1rem 2rem;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: #666;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: #667eea;
        background-color: rgba(102, 126, 234, 0.1);
    }

    .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .chart-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #333;
    }

    .metrics-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .metrics-table th {
        background: #667eea;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .metrics-table td {
        padding: 0.9rem 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .metrics-table tr:hover {
        background-color: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 0.35rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-badge.passed {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.partial {
        background: #fff3cd;
        color: #856404;
    }

    .export-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s ease;
        margin-bottom: 1.5rem;
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container metrics-dashboard">
    <h1 class="text-center mb-4">üìä Comprehensive Metrics Dashboard</h1>
    <p class="text-center text-muted mb-5">Real-time validation of all thesis hypotheses (H1-H4)</p>

    <!-- KPI Summary Cards -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="kpi-card success">
                <div class="kpi-label">H1: Security Efficacy</div>
                <div class="kpi-value" id="kpi-h1">256-bit</div>
                <small>AES-256-GCM Encryption</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card info">
                <div class="kpi-label">H2: Computational Accuracy</div>
                <div class="kpi-value" id="kpi-h2">‚Äî</div>
                <small>Mean & Variance Precision</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card warning">
                <div class="kpi-label">H3: Cloud Overhead</div>
                <div class="kpi-value" id="kpi-h3">54%</div>
                <small>Storage Savings vs Pure CKKS</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card success">
                <div class="kpi-label">H4: Compliance Score</div>
                <div class="kpi-value" id="kpi-h4">‚Äî</div>
                <small>GDPR/HIPAA Requirements</small>
            </div>
        </div>
    </div>

    <!-- Export Button -->
    <div class="text-right">
        <button class="export-btn" onclick="exportMetricsReport()">
            üì• Export Full Metrics Report (JSON)
        </button>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="showTab('performance')">‚ö° Performance</button>
        <button class="tab-btn" onclick="showTab('accuracy')">üéØ Accuracy</button>
        <button class="tab-btn" onclick="showTab('security')">üîí Security</button>
        <button class="tab-btn" onclick="showTab('compliance')">‚úÖ Compliance</button>
    </div>

    <!-- Performance Tab -->
    <div id="tab-performance" class="tab-content active">
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <h3 class="chart-title">Memory Usage Comparison</h3>
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">Storage Expansion Factors</h3>
                    <canvas id="storageChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">End-to-End Latency Breakdown</h3>
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Accuracy Tab -->
    <div id="tab-accuracy" class="tab-content">
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <h3 class="chart-title">H2: Accuracy Metrics by Dataset Size</h3>
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h3 class="mb-3">Detailed Accuracy Results</h3>
                <table class="metrics-table" id="accuracyTable">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Records</th>
                            <th>Plaintext</th>
                            <th>Decrypted</th>
                            <th>MSE</th>
                            <th>RMSE</th>
                            <th>Accuracy %</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="accuracyTableBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="loader"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Security Tab -->
    <div id="tab-security" class="tab-content">
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">H1: Data Segmentation</h3>
                    <canvas id="segmentationChart"></canvas>
                    <div class="mt-3">
                        <p><strong>PII Fields (6):</strong> patient_id, name, address, phone, email, dob ‚Üí <span
                                class="badge badge-danger">AES-256-GCM</span></p>
                        <p><strong>Vitals (7):</strong> heart_rate, blood_pressure_sys, blood_pressure_dia, temperature,
                            glucose, bmi, cholesterol ‚Üí <span class="badge badge-info">CKKS</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">Encryption Standards</h3>
                    <table class="metrics-table">
                        <tr>
                            <th>Scheme</th>
                            <th>Security Level</th>
                            <th>Standard</th>
                        </tr>
                        <tr>
                            <td>AES-256-GCM</td>
                            <td>256-bit</td>
                            <td>NIST FIPS 197</td>
                        </tr>
                        <tr>
                            <td>CKKS</td>
                            <td>128-bit (RLWE)</td>
                            <td>Post-quantum</td>
                        </tr>
                    </table>

                    <h4 class="mt-4">Key Isolation</h4>
                    <ul>
                        <li>‚úÖ Secret keys stored client-side only</li>
                        <li>‚úÖ Zero-knowledge server architecture</li>
                        <li>‚úÖ Public/Galois keys uploaded (safe)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Tab -->
    <div id="tab-compliance" class="tab-content">
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">H4: Compliance Radar Chart</h3>
                    <canvas id="complianceChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h3 class="chart-title">Compliance Summary</h3>
                    <div class="alert alert-success">
                        <h4>Overall Compliance: <strong id="complianceScore">‚Äî</strong></h4>
                        <p>Target: ‚â•95% | Status: <span class="status-badge passed">PASSED</span></p>
                    </div>
                    <p><strong id="fullyCompliantCount">‚Äî</strong> requirements at 100%</p>
                    <p><strong id="totalRequirements">‚Äî</strong> total requirements evaluated</p>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <h3 class="mb-3">Detailed Compliance Matrix</h3>
                <table class="metrics-table" id="complianceTable">
                    <thead>
                        <tr>
                            <th>Requirement</th>
                            <th>GDPR Article</th>
                            <th>HIPAA Rule</th>
                            <th>Status</th>
                            <th>Compliant</th>
                        </tr>
                    </thead>
                    <tbody id="complianceTableBody">
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="loader"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Tab switching
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById('tab-' + tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // Fetch and update KPIs
    async function loadKPIs() {
        try {
            const response = await fetch('/api/metrics/kpis');
            const data = await response.json();

            document.getElementById('kpi-h2').textContent = data.h2_accuracy.mean_accuracy_range;
            document.getElementById('kpi-h4').textContent = data.h4_compliance.overall_score + '%';
        } catch (error) {
            console.error('Error loading KPIs:', error);
        }
    }

    // Fetch and render accuracy data
    async function loadAccuracyData() {
        try {
            const response = await fetch('/api/metrics/accuracy');
            const data = await response.json();

            // Update table
            const tbody = document.getElementById('accuracyTableBody');
            tbody.innerHTML = '';

            data.operations.forEach(op => {
                const row = `
                    <tr>
                        <td>${op.operation}</td>
                        <td>${op.record_count.toLocaleString()}</td>
                        <td>${op.plaintext_result.toFixed(6)}</td>
                        <td>${op.decrypted_result.toFixed(6)}</td>
                        <td>${op.mse.toExponential(2)}</td>
                        <td>${op.rmse.toExponential(2)}</td>
                        <td><strong>${op.accuracy_pct.toFixed(3)}%</strong></td>
                        <td><span class="status-badge passed">‚úì PASSED</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Render accuracy chart
            renderAccuracyChart(data.operations);
        } catch (error) {
            console.error('Error loading accuracy data:', error);
            document.getElementById('accuracyTableBody').innerHTML =
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        }
    }

    // Render accuracy chart
    function renderAccuracyChart(operations) {
        const ctx = document.getElementById('accuracyChart').getContext('2d');

        const meanOps = operations.filter(op => op.operation === 'mean');
        const varianceOps = operations.filter(op => op.operation === 'variance');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: meanOps.map(op => op.record_count.toLocaleString() + ' records'),
                datasets: [{
                    label: 'Mean Accuracy (%)',
                    data: meanOps.map(op => op.accuracy_pct),
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2
                }, {
                    label: 'Variance Accuracy (%)',
                    data: varianceOps.map(op => op.accuracy_pct),
                    backgroundColor: 'rgba(241, 143, 1, 0.8)',
                    borderColor: 'rgba(241, 143, 1, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 95,
                        max: 100,
                        title: { display: true, text: 'Accuracy (%)' }
                    }
                },
                plugins: {
                    title: { display: false }
                }
            }
        });
    }

    // Load compliance data
    async function loadComplianceData() {
        try {
            const response = await fetch('/api/metrics/compliance');
            const data = await response.json();

            document.getElementById('complianceScore').textContent = data.overall_score.toFixed(0) + '%';
            document.getElementById('fullyCompliantCount').textContent = data.fully_compliant_count;
            document.getElementById('totalRequirements').textContent = data.total_requirements;

            // Update table
            const tbody = document.getElementById('complianceTableBody');
            tbody.innerHTML = '';

            data.requirements.forEach(req => {
                const statusBadge = req.status === '100%' ? 'passed' : 'partial';
                const row = `
                    <tr>
                        <td>${req.name}</td>
                        <td>${req.gdpr}</td>
                        <td>${req.hipaa}</td>
                        <td><span class="status-badge ${statusBadge}">${req.status}</span></td>
                        <td>${req.compliant ? '‚úÖ' : '‚ùå'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            renderComplianceRadar(data.requirements);
        } catch (error) {
            console.error('Error loading compliance data:', error);
        }
    }

    // Render compliance radar chart
    function renderComplianceRadar(requirements) {
        const ctx = document.getElementById('complianceChart').getContext('2d');

        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: requirements.map(r => r.name),
                datasets: [{
                    label: 'Achieved (%)',
                    data: requirements.map(r => parseInt(r.status)),
                    backgroundColor: 'rgba(6, 167, 125, 0.2)',
                    borderColor: 'rgba(6, 167, 125, 1)',
                    pointBackgroundColor: 'rgba(6, 167, 125, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(6, 167, 125, 1)'
                }, {
                    label: 'Target (95%)',
                    data: Array(requirements.length).fill(95),
                    backgroundColor: 'rgba(217, 4, 41, 0.1)',
                    borderColor: 'rgba(217, 4, 41, 1)',
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Render memory chart
    async function loadMemoryData() {
        try {
            const response = await fetch('/api/metrics/memory');
            const data = await response.json();

            const ctx = document.getElementById('memoryChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.encryption.map(d => d.dataset_size.toLocaleString() + ' records'),
                    datasets: [{
                        label: 'Baseline (MB)',
                        data: data.encryption.map(d => d.baseline_mb),
                        backgroundColor: 'rgba(255, 160, 122, 0.8)'
                    }, {
                        label: 'Optimized (MB)',
                        data: data.encryption.map(d => d.optimized_mb),
                        backgroundColor: 'rgba(78, 205, 196, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Memory Usage (MB)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading memory data:', error);
        }
    }

    // Render storage chart
    async function loadStorageChart() {
        try {
            const response = await fetch('/api/metrics/storage');
            const data = await response.json();

            const ctx = document.getElementById('storageChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['AES-256', 'CKKS'],
                    datasets: [{
                        label: 'Expansion Factor',
                        data: [data.aes.expansion_factor, data.ckks.expansion_factor],
                        backgroundColor: ['rgba(255, 107, 107, 0.8)', 'rgba(78, 205, 196, 0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Expansion Factor (log scale)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading storage data:', error);
        }
    }

    // Render latency breakdown
    // Render latency breakdown
    async function loadLatencyChart() {
        try {
            const response = await fetch('/api/metrics/latency');
            const data = await response.json();

            const labels = data.breakdown.map(b => b.label);
            const values = data.breakdown.map(b => b.value * 1000); // Convert to ms

            const ctx = document.getElementById('latencyChart').getContext('2d');

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(255, 107, 107, 0.8)',
                            'rgba(247, 127, 0, 0.8)',
                            'rgba(162, 59, 114, 0.8)',
                            'rgba(78, 205, 196, 0.8)',
                            'rgba(147, 51, 234, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.parsed.toFixed(2) + 'ms';
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading latency data:', error);
        }
    }

    // Render data segmentation pie chart
    function loadSegmentationChart() {
        const ctx = document.getElementById('segmentationChart').getContext('2d');

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['PII (AES-256)', 'Vitals (CKKS)'],
                datasets: [{
                    data: [46.2, 53.8],
                    backgroundColor: ['rgba(255, 107, 107, 0.8)', 'rgba(78, 205, 196, 0.8)']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: false }
                }
            }
        });
    }

    // Export metrics report
    async function exportMetricsReport() {
        try {
            window.location.href = '/api/metrics/export';
        } catch (error) {
            alert('Error exporting report: ' + error.message);
        }
    }

    // Initialize dashboard
    window.addEventListener('DOMContentLoaded', () => {
        loadKPIs();
        loadAccuracyData();
        loadComplianceData();
        loadMemoryData();
        loadStorageChart();
        loadLatencyChart();
        loadSegmentationChart();
    });
</script>
{% endblock %}