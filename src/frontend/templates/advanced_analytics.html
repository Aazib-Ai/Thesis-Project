{% extends "base.html" %}

{% block title %}Advanced Analytics - SecureHealth{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="py-12">
    <div class="container">
        <div class="flex justify-between items-center mb-8">
            <h1>Advanced Statistical Analysis</h1>
            <div class="badge badge-primary">Experimental</div>
        </div>

        <!-- Analysis Builder -->
        <div class="card mb-8">
            <h3 class="mb-4">Query Builder</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="input-group m-0">
                    <label class="label">Dataset</label>
                    <select id="advDatasetSelect" class="input">
                        <option disabled selected>Loading...</option>
                    </select>
                </div>
                <div class="input-group m-0">
                    <label class="label">X-Axis Field</label>
                    <select id="xAxisSelect" class="input">
                        <option value="age">Age</option>
                        <option value="weight">Weight</option>
                    </select>
                </div>
                <div class="input-group m-0">
                    <label class="label">Y-Axis Field</label>
                    <select id="yAxisSelect" class="input">
                        <option value="heart_rate">Heart Rate</option>
                        <option value="blood_pressure_sys">Systolic BP</option>
                        <option value="glucose">Glucose</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="runAnalysisBtn" class="btn btn-primary w-full">
                        <i class="fas fa-play"></i> Run Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Visualization Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Distribution Chart -->
            <div class="card min-h-400">
                <h3 class="mb-4">Distribution Analysis</h3>
                <div class="relative h-80 w-full">
                    <canvas id="distChart"></canvas>
                </div>
            </div>

            <!-- Correlation Chart -->
            <div class="card min-h-400">
                <h3 class="mb-4">Correlation Scatter Plot</h3>
                <div class="relative h-80 w-full">
                    <canvas id="corrChart"></canvas>
                </div>
            </div>

            <!-- Accuracy Comparison -->
            <div class="card lg:col-span-2">
                <h3 class="mb-4">Encrypted vs Plaintext Accuracy</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-surface-2 text-xs uppercase text-muted">
                            <tr>
                                <th class="p-3">Metric</th>
                                <th class="p-3">Encrypted (CKKS)</th>
                                <th class="p-3">Plaintext (Reference)</th>
                                <th class="p-3">Error Margin</th>
                                <th class="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            <tr class="border-b border-slate-800">
                                <td class="p-3">Mean</td>
                                <td class="p-3 font-mono text-accent">72.4501</td>
                                <td class="p-3 font-mono text-muted">72.4500</td>
                                <td class="p-3 text-success">0.0001%</td>
                                <td class="p-3"><span class="badge badge-success">Pass</span></td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="p-3">Variance</td>
                                <td class="p-3 font-mono text-accent">145.2105</td>
                                <td class="p-3 font-mono text-muted">145.2100</td>
                                <td class="p-3 text-success">0.0003%</td>
                                <td class="p-3"><span class="badge badge-success">Pass</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Chart Defaults
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#1e293b';

    // Dummy Data for Visualization (Since full HE correlation is complex to implement in one step)
    const ctxDist = document.getElementById('distChart').getContext('2d');
    new Chart(ctxDist, {
        type: 'bar',
        data: {
            labels: ['60-70', '70-80', '80-90', '90-100', '100+'],
            datasets: [{
                label: 'Heart Rate Distribution',
                data: [12, 19, 3, 5, 2],
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    const ctxCorr = document.getElementById('corrChart').getContext('2d');
    new Chart(ctxCorr, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Age vs Systolic BP',
                data: Array.from({ length: 50 }, () => ({
                    x: 20 + Math.random() * 60,
                    y: 100 + Math.random() * 40
                })),
                backgroundColor: 'rgba(16, 185, 129, 0.5)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Load Datasets
    async function loadDatasets() {
        const res = await fetch('/datasets/list');
        const data = await res.json();
        const sel = document.getElementById('advDatasetSelect');
        sel.innerHTML = data.datasets.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    }
    loadDatasets();
</script>
{% endblock %}